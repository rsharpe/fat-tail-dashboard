<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fat Tail Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <script type="module">
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "fattailjournal.firebaseapp.com",
      projectId: "fattailjournal",
      storageBucket: "fattailjournal.appspot.com",
      messagingSenderId: "...",
      appId: "1:...:web:..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Expose saveTradeNote globally
    window.saveTradeNote = async function () {
      const note = document.getElementById('tradeNotes').value;
      const tags = Array.from(document.querySelectorAll('#tagInputContainer .tag')).map(tag => tag.textContent);
      if (!note) return;

      try {
        await addDoc(collection(db, "tradeNotes"), {
          note: note,
          tags: Array.from(document.querySelectorAll('#tagInputContainer .tag')).map(tag => tag.textContent),
          timestamp: new Date().toISOString()
        });

        const timestamp = new Date().toLocaleString();
        const entry = `<p><strong>${timestamp}</strong>: ${note}</p>`;
        document.getElementById('tradeHistory').innerHTML += entry;
        document.getElementById('tradeNotes').value = '';
        document.getElementById('tagInputContainer').innerHTML = '';
        document.getElementById('tagInput').value = '';
        document.getElementById('tagInputContainer').innerHTML = ''; document.getElementById('tagInput').value = '';
      } catch (e) {
        console.error("Error adding document: ", e);
      }
    }
  auth.onAuthStateChanged(user => {
      const status = document.getElementById('userStatus');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const proTools = document.getElementById('proTools');
      if (user) {
        status.textContent = `Logged in as: ${user.displayName}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        proTools.style.display = 'block';
      } else {
        status.textContent = 'Not logged in';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        proTools.style.display = 'none';
      }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error("Login error", e);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error("Logout error", e);
      }
    });

window.exportNotesToPDF = function () {
  const notes = window._firebaseNotes || [];
  if (!notes.length) return alert("No notes loaded to export.");

  const content = notes.map(n => `${n.time}
${n.note}
Tags: ${(n.tags || []).join(', ')}

`).join('');
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "fat_tail_journal.txt");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
window.handleTagInput = function(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    const input = event.target;
    const tagText = input.value.trim();
    if (tagText !== '') {
      const pill = document.createElement('span');
      pill.textContent = tagText;
      pill.className = 'tag';
      pill.style.cssText = 'background:#227a74;color:#fff;padding:2px 6px;border-radius:12px;font-size:0.65rem;display:inline-block;';
      pill.onclick = () => pill.remove();
      document.getElementById('tagInputContainer').appendChild(pill);
      input.value = '';
    }
  }
};
window.addSuggestedTag = function(tagText) {
  const existingTags = Array.from(document.querySelectorAll('#tagInputContainer .tag')).map(tag => tag.textContent);
  if (!existingTags.includes(tagText)) {
    const pill = document.createElement('span');
    pill.textContent = tagText;
    pill.className = 'tag';
    pill.style.cssText = 'background:#227a74;color:#fff;padding:2px 6px;border-radius:12px;font-size:0.65rem;display:inline-block;margin:2px;';
    pill.onclick = () => pill.remove();
    document.getElementById('tagInputContainer').appendChild(pill);
  }
};
window.displayAnalytics = function () {
  const panel = document.getElementById("analyticsPanel");
  const notes = window._firebaseNotes || [];
  const tagStats = {};

  notes.forEach(note => {
    const noteText = note.note || "";
    const match = noteText.match(/P\/?L\s*[:=]?\s*[-+]?\$?-?\d+(\.\d+)?/i);
    let pnlValue = 0;
    if (match) {
      const num = match[0].match(/-?\d+(\.\d+)?/);
      if (num) pnlValue = parseFloat(num[0]);
    }

    (note.tags || []).forEach(tag => {
      if (!tagStats[tag]) tagStats[tag] = { count: 0, pnl: 0 };
      tagStats[tag].count++;
      tagStats[tag].pnl += pnlValue;
    });
  });

  const chartData = Object.entries(tagStats).map(([tag, data]) => {
    return `<div style='margin-bottom:0.25rem;'>
      <strong>${tag}</strong>: ${data.count} trades | P/L: $${data.pnl.toFixed(2)}
      <div style='height: 8px; background:#ccc; width:100%;'>
        <div style='height:8px; background:#227a74; width:${Math.min(data.count * 20, 100)}%;'></div>
      </div>
    </div>`;
  }).join('');

  panel.innerHTML = Object.keys(tagStats).length ? chartData :
    '<p>No tag data available. Save some tagged trades to see analytics.</p>';
};

};
</script>
  <style>
    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #2f8c83;
      color: #ff5e99;
      margin: 0;
      padding: 0.4rem;
      font-size: 0.65rem;
    }
    h1, h2 {
      color: #0d3b3f;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background-color: #fff6ea;
      padding: 0.5rem;
      border: 1px solid #081e1f;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 10px rgba(13, 59, 63, 0.3);
    }
    label {
      display: block;
      margin: 0.5rem 0 0.25rem;
      color: #1f4046;
    }
    input[type="file"] {
      font-size: 0.75rem;
    }

input, textarea {
    button {
      background-color: #227a74;
      color: #fff;
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 0.3rem;
    }
    .result {
      margin-top: 1rem;
      font-size: 1rem;
    }
    iframe {
      width: 100%;
      border: none;
      border-radius: 0.5rem;
    }
    .csv-table {
      margin-top: 1rem;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #00ffcc;
    }
    th, td {
      border: 1px solid #00ffcc;
      padding: 0.5rem;
      text-align: left;
    }
    @media (min-width: 768px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
      .full-width {
        grid-column: span 2;
      }
    }
  a:hover {
      color: #1c4e57;
      text-decoration: underline;
    }

    footer {
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
a:hover {
      color: #0e2b30;
      text-decoration: underline;
    }

</style>
</head>
<body>
  <h1 style="color: #ff9933; font-weight: 100; letter-spacing: -2px; font-size: 1.25rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);">Fat Tail Trading Terminal</h1>
  <div class="container">

    <div class="card">
      <h2>&sigma;-Distance Calculator</h2>
      <label for="spot">SPX Spot Price:</label>
      <input type="number" id="spot" placeholder="e.g., 5860" />
      <label for="iv">Implied Volatility (%):</label>
      <input type="number" id="iv" placeholder="e.g., 16" />
      <label for="dte">Days to Expiration (DTE):</label>
      <input type="number" id="dte" placeholder="e.g., 7" />
      <button onclick="calculateSigmaZones()">Calculate Zones</button>
      <div class="result" id="sigmaResults"></div>
    </div>

    <div class="card">
      <h2>Manual Trade Journal</h2>
      <label for="tradeNotes">Trade Notes:</label>
      $1
        <div id="tagSuggestions" style="margin-top: 0.5rem;">
          <button type="button" onclick="addSuggestedTag('SPX')">SPX</button>
          <button type="button" onclick="addSuggestedTag('NDX')">NDX</button>
          <button type="button" onclick="addSuggestedTag('butterfly')">butterfly</button>
          <button type="button" onclick="addSuggestedTag('0DTE')">0DTE</button>
          <button type="button" onclick="addSuggestedTag('7DTE')">7DTE</button>
          <button type="button" onclick="addSuggestedTag('credit')">credit</button>
          <button type="button" onclick="addSuggestedTag('debit')">debit</button>
          <button type="button" onclick="addSuggestedTag('campaign1')">campaign1</button>
        </div>
      $2
      <input id="tagInput" type="text" placeholder="Enter tag and press enter" onkeydown="handleTagInput(event)" style="width: 100%; padding: 0.3rem; border: 1px solid #ccc; border-radius: 4px;" />
      <textarea id="tradeNotes" rows="6" placeholder="SPX 6100/6150/6200 OTM butterfly, 7 DTE, IV: 16%..."></textarea>
      <button onclick="saveTradeNote()">Save Note</button>
      <div id="tradeHistory"></div>
    </div>

    

    <div class="card full-width">
      <h2>Upload ThinkOrSwim CSV Log</h2>
      <input type="file" id="csvFile" accept=".csv" />
      <div class="csv-table" id="csvOutput"></div>
    </div>

    <div class="card full-width">
      <h2>Journal Log History (Live from Firebase)</h2>
      <button onclick="exportNotesToPDF()">Export to PDF</button>
      <label for="tagFilter">Filter by Tag:</label>
      <input type="text" id="tagFilter" placeholder="e.g., SPX, butterfly" oninput="filterTradeNotes()" />
      <button onclick="exportNotesToCSV()">Export to CSV</button><br/><br/>
      <label for="searchFilter">Search notes:</label>
      <input type="text" id="searchFilter" placeholder="e.g., SPX, butterfly, IV" oninput="filterTradeNotes()" />
      <button onclick="loadTradeNotes()">Load Saved Notes</button>
      <div id="remoteHistory"></div>
    </div>

    <div class="card full-width" id="proModeCard">
  <h2>Pro Mode Login</h2>
  <p>This feature is reserved for subscribers. Log in to unlock strategy tagging, profit analytics, and premium exports.</p>
  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <p id="userStatus">Not logged in</p>
</div>

<div class="card full-width" id="proTools" style="display: none;">
  <h2>📊 Pro Mode Analytics</h2>
  <div id="analyticsPanel">
    <p style="font-style: italic;">Loading tag-based performance metrics...</p>
  </div>
</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "fattailjournal.firebaseapp.com",
      projectId: "fattailjournal",
      storageBucket: "fattailjournal.appspot.com",
      messagingSenderId: "...",
      appId: "1:...:web:..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.saveTradeNote = async function () {
      const note = document.getElementById('tradeNotes').value;
      if (!note) return;

      try {
        await addDoc(collection(db, "tradeNotes"), {
          note: note,
          tags: tags,
          timestamp: new Date().toISOString()
        });

        const timestamp = new Date().toLocaleString();
        const entry = `<p><strong>${timestamp}</strong>: ${note}</p>`;
        document.getElementById('tradeHistory').innerHTML += entry;
        document.getElementById('tradeNotes').value = '';
      } catch (e) {
        console.error("Error adding document: ", e);
      }
    }

    window.loadTradeNotes = async function () {
      const notesRef = collection(db, "tradeNotes");
      const q = query(notesRef, orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      const container = document.getElementById("remoteHistory");
      container.innerHTML = '';
      window._firebaseNotes = [];
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const time = new Date(data.timestamp).toLocaleString();
        const entry = {
          time,
          note: data.note,
          tags: data.tags || []
        };
        window._firebaseNotes.push(entry);
      });
      filterTradeNotes();
      if (document.getElementById('proTools').style.display === 'block') displayAnalytics();
    };

window.filterTradeNotes = function () {
    const searchValue = document.getElementById("searchFilter").value.toLowerCase();
    const tagValue = document.getElementById("tagFilter").value.toLowerCase();
    const container = document.getElementById("remoteHistory");
    container.innerHTML = '';
    (window._firebaseNotes || []).forEach(entry => {
      const matchesNote = entry.note.toLowerCase().includes(searchValue);
      const matchesTag = tagValue ? entry.tags.some(tag => tag.toLowerCase().includes(tagValue)) : true;
      if (matchesNote && matchesTag) {
        container.innerHTML += `<p><strong>${entry.time}</strong>: ${entry.note}<br><em>Tags: ${entry.tags.join(', ')}</em></p>`;
      }
    });
  };
</script>
<footer style="margin-top: 3rem; text-align: center; color: #1f4046;">
  <hr style="border-color: #00ffcc;">
  <a href="https://www.tradingview.com/" target="_blank" style="color: #1f4046;">TradingView Charts</a> |
    <a href="https://www.tdameritrade.com" target="_blank" style="color: #1f4046;">ThinkOrSwim by Charles Schwab</a> |
    <a href="https://optionalpha.com/?ref=YOUR_ID" target="_blank" style="color: #1f4046;">Option Alpha Education</a> |
    <a href="https://www.tastytrade.com" target="_blank" style="color: #1f4046;">TastyTrade</a> |
    <a href="https://robinhood.com" target="_blank" style="color: #1f4046;">Robinhood</a> |
    <a href="https://www.interactivebrokers.com" target="_blank" style="color: #1f4046;">Interactive Brokers</a>
  <p style="color: #1f4046;"><strong>Pro Mode coming soon:</strong> analytics, strategy tagging, and cloud sync — stay tuned.</p>
</footer>
</body>
</html>
