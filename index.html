<!-- Restored tag button panel for journaling precision + Firebase Fixes -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fat Tail Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "fattailjournal.firebaseapp.com",
      projectId: "fattailjournal",
      storageBucket: "fattailjournal.appspot.com",
      messagingSenderId: "...",
      appId: "1:...:web:..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.saveTradeNote = async function () {
      const note = document.getElementById('tradeNotes').value;
      if (!note) return;

      const tags = Array.from(document.querySelectorAll('.tag-pill')).map(el => el.textContent);
      try {
        await addDoc(collection(db, "tradeNotes"), {
          note: note,
          tags: tags,
          timestamp: new Date().toISOString()
        });

        const timestamp = new Date().toLocaleString();
        const entry = `<p><strong>${timestamp}</strong>: ${note} <br/><em>Tags:</em> ${tags.join(', ')}</p>`;
        document.getElementById('tradeHistory').innerHTML += entry;
        document.getElementById('tradeNotes').value = '';
        document.getElementById('tagInputContainer').innerHTML = '';
      } catch (e) {
        console.error("Error adding document: ", e);
      }
    }

    window.loadTradeNotes = async function () {
      const notesRef = collection(db, "tradeNotes");
      const q = query(notesRef, orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      const container = document.getElementById("remoteHistory");
      container.innerHTML = '';
      window._firebaseNotes = [];
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const time = new Date(data.timestamp).toLocaleString();
        const entry = {
          time,
          note: data.note,
          tags: data.tags || []
        };
        window._firebaseNotes.push(entry);
      });
      filterTradeNotes();
    };

    window.filterTradeNotes = function () {
      const searchValue = document.getElementById("searchFilter").value.toLowerCase();
      const tagValue = document.getElementById("tagFilter").value.toLowerCase();
      const container = document.getElementById("remoteHistory");
      container.innerHTML = '';

      (window._firebaseNotes || []).forEach(entry => {
        const matchesSearch = entry.note.toLowerCase().includes(searchValue);
        const matchesTag = tagValue ? (entry.tags || []).some(tag => tag.toLowerCase().includes(tagValue)) : true;
        if (matchesSearch && matchesTag) {
          container.innerHTML += `<p><strong>${entry.time}</strong>: ${entry.note}<br/><em>Tags:</em> ${entry.tags.join(', ')}</p>`;
        }
      });
    }

    window.exportToPDF = function () {
      import("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js").then(jsPDF => {
        const { jsPDF: PDF } = jsPDF;
        const doc = new PDF();
        const entries = window._firebaseNotes || [];
        let y = 10;
        entries.forEach(entry => {
          const text = `${entry.time}: ${entry.note} [${entry.tags.join(', ')}]`;
          doc.text(text, 10, y);
          y += 10;
        });
        doc.save("fat_tail_journal.pdf");
      });
    }
  </script>
</head>
<body>
<!-- your body content stays the same, already in canvas -->
</body>
</html>
