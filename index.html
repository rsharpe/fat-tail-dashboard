<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fat Tail Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <script type="module">
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "fattailjournal.firebaseapp.com",
      projectId: "fattailjournal",
      storageBucket: "fattailjournal.appspot.com",
      messagingSenderId: "...",
      appId: "1:...:web:..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Expose saveTradeNote globally
    window.saveTradeNote = async function () {
      const user = auth.currentUser;
      if (!user) return alert("Please sign in to save notes.");
      const note = document.getElementById('tradeNotes').value;
      if (!note) return;

      try {
        await addDoc(collection(db, "tradeNotes"), {
          note: note,
          tags: document.getElementById('tags').value.split(',').map(t => t.trim()),
          timestamp: new Date().toISOString()
        });

        const timestamp = new Date().toLocaleString();
        const entry = `<p><strong>${timestamp}</strong>: ${note}</p>`;
        document.getElementById('tradeHistory').innerHTML += entry;
        document.getElementById('tradeNotes').value = '';
        document.getElementById('tags').value = '';
      } catch (e) {
        console.error("Error adding document: ", e);
      }
    }
  auth.onAuthStateChanged(user => {
      const status = document.getElementById('userStatus');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      if (user) {
        status.textContent = `Logged in as: ${user.displayName}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
      } else {
        status.textContent = 'Not logged in';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
      }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error("Login error", e);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error("Logout error", e);
      }
    });

</script>
  <style>
    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #2f8c83;
      color: #ff5e99;
      margin: 0;
      padding: 0.4rem;
      font-size: 0.65rem;
    }
    h1, h2 {
      color: #0d3b3f;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background-color: #fff6ea;
      padding: 0.5rem;
      border: 1px solid #081e1f;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 10px rgba(13, 59, 63, 0.3);
    }
    label {
      display: block;
      margin: 0.5rem 0 0.25rem;
    }
    input, textarea {
      width: 100%;
      background-color: #fff8f0;
      color: #ff5e99;
      border: 1px solid #faae7b;
      padding: 0.25rem;
      border-radius: 4px;
      font-family: 'Roboto Mono', monospace;
    }
    button {
      background-color: #227a74;
      color: #fff;
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 0.3rem;
    }
    .result {
      margin-top: 1rem;
      font-size: 1rem;
    }
    iframe {
      width: 100%;
      border: none;
      border-radius: 0.5rem;
    }
    .csv-table {
      margin-top: 1rem;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #00ffcc;
    }
    th, td {
      border: 1px solid #00ffcc;
      padding: 0.5rem;
      text-align: left;
    }
    @media (min-width: 768px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
      .full-width {
        grid-column: span 2;
      }
    }
  </style>
</head>
<body>
  <h1 style="color: #cc2485; font-weight: 100; letter-spacing: -2px; font-size: 1.25rem; text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);">Fat Tail Trading Terminal</h1>
  <div class="container">

    <div class="card">
      <h2>&sigma;-Distance Calculator</h2>
      <label for="spot">SPX Spot Price:</label>
      <input type="number" id="spot" placeholder="e.g., 5860" />
      <label for="iv">Implied Volatility (%):</label>
      <input type="number" id="iv" placeholder="e.g., 16" />
      <label for="dte">Days to Expiration (DTE):</label>
      <input type="number" id="dte" placeholder="e.g., 7" />
      <button onclick="calculateSigmaZones()">Calculate Zones</button>
      <div class="result" id="sigmaResults"></div>
    </div>

    <div class="card">
      <h2>Manual Trade Journal</h2>
      <label for="tradeNotes">Trade Notes:</label>
      <textarea id="tags" rows="1" placeholder="Enter tags (comma separated)"></textarea>
      <textarea id="tradeNotes" rows="6" placeholder="SPX 6100/6150/6200 OTM butterfly, 7 DTE, IV: 16%..."></textarea>
      <button onclick="saveTradeNote()">Save Note</button>
      <div id="tradeHistory"></div>
    </div>

    

    <div class="card full-width">
      <h2>Upload ThinkOrSwim CSV Log</h2>
      <input type="file" id="csvFile" accept=".csv" />
      <div class="csv-table" id="csvOutput"></div>
    </div>

    <div class="card full-width">
      <h2>Journal Log History (Live from Firebase)</h2>
      <button onclick="exportNotesToCSV()">Export to CSV</button><br/><br/>
      <label for="searchFilter">Search notes:</label>
      <input type="text" id="searchFilter" placeholder="e.g., SPX, butterfly, IV" oninput="filterTradeNotes()" />
      <button onclick="loadTradeNotes()">Load Saved Notes</button>
      <div id="remoteHistory"></div>
    </div>

    <div class="card full-width">
      <h2>Pro Mode Login</h2>
      <p>This feature is reserved for subscribers. Log in to unlock strategy tagging, profit analytics, and premium exports.</p>
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
      <p id="userStatus">Not logged in</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIza...",
      authDomain: "fattailjournal.firebaseapp.com",
      projectId: "fattailjournal",
      storageBucket: "fattailjournal.appspot.com",
      messagingSenderId: "...",
      appId: "1:...:web:..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.saveTradeNote = async function () {
      const note = document.getElementById('tradeNotes').value;
      if (!note) return;

      try {
        await addDoc(collection(db, "tradeNotes"), {
          note: note,
          timestamp: new Date().toISOString()
        });

        const timestamp = new Date().toLocaleString();
        const entry = `<p><strong>${timestamp}</strong>: ${note}</p>`;
        document.getElementById('tradeHistory').innerHTML += entry;
        document.getElementById('tradeNotes').value = '';
      } catch (e) {
        console.error("Error adding document: ", e);
      }
    }

    window.loadTradeNotes = async function () {
      const notesRef = collection(db, "tradeNotes");
      const q = query(notesRef, orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      const container = document.getElementById("remoteHistory");
      container.innerHTML = '';
      window._firebaseNotes = [];
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const time = new Date(data.timestamp).toLocaleString();
        const entry = {
          time,
          note: data.note,
          tags: data.tags || []
        };
        window._firebaseNotes.push(entry);
      });
      filterTradeNotes();
    };

window.filterTradeNotes = function () {
    const searchValue = document.getElementById("searchFilter").value.toLowerCase();
    const container = document.getElementById("remoteHistory");
    container.innerHTML = '';
    (window._firebaseNotes || []).forEach(entry => {
      if (entry.note.toLowerCase().includes(searchValue)) {
        container.innerHTML += `<p><strong>${entry.time}</strong>: ${entry.note}<br><em>Tags: ${entry.tags.join(', ')}</em></p>`;
      }
    });
  }
  window.exportNotesToCSV = function () {
  const notes = window._firebaseNotes || [];
  if (!notes.length) return alert("No notes loaded to export.");

  const csvHeader = "Timestamp,Note,Tags\r\n";
const csvRows = notes.map(n => 
  `"${n.time.replace(/"/g, '""')}","${n.note.replace(/"/g, '""')}","${(n.tags || []).join(';')}"`
).join("\r\n");

  const csvContent = csvHeader + csvRows;
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "fat_tail_journal.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
</script>
<footer style="margin-top: 3rem; text-align: center; color: #333;">
  <hr style="border-color: #00ffcc;">
  <a href="https://www.tradingview.com/" target="_blank" style="color: #333;">TradingView Charts</a> |
    <a href="https://www.tdameritrade.com" target="_blank" style="color: #333;">ThinkOrSwim by Charles Schwab</a> |
    <a href="https://optionalpha.com/?ref=YOUR_ID" target="_blank" style="color: #333;">Option Alpha Education</a> |
    <a href="https://www.tastytrade.com" target="_blank" style="color: #333;">TastyTrade</a> |
    <a href="https://robinhood.com" target="_blank" style="color: #333;">Robinhood</a> |
    <a href="https://www.interactivebrokers.com" target="_blank" style="color: #333;">Interactive Brokers</a>
  <p style="color: #333;"><strong>Pro Mode coming soon:</strong> analytics, strategy tagging, and cloud sync — stay tuned.</p>
</footer>
</body>
</html>
